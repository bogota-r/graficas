---
title: "Gráficas en R"
---

```{r setup, echo = FALSE, warnings = FALSE, message = FALSE}
plot_methods <- methods("plot")

library("graphics")
library("grid")
library("lattice")
library("ggplot2")

# Scales for ggplot2
library("scales")

# png files
library("png")

# Lo de siempre
library("magrittr")
library("dplyr")
library("tidyr")

# Datos para ejemplos
library("saber") # Ver github.com/nebulae-co/saber
library("forecast")

data("diamonds")
data("iris")
data("mtcars")

# Algunas opciones de knitr
library("knitr")

opts_chunk$set(message = FALSE,
               comment = "#>",
               dev.args = list(bg = "transparent"))

theme_update(plot.background = element_rect(fill = "transparent",
                                            colour = "transparent"))
```

## Motivación

```{r motivacion, child = "graficas_files/motivacion.rmd"}
```

# Gráficas en R

## Contenido (I)
<!-- Esto es solo para guiarnos luego miramos si lo dejamos o no --> 

- Qué es R (por si acaso)
- Gráficas Base
    * Métodos - Todo de una: `plot()`
    * Componentes de bajo nivel
    * Ejemplos
- Grid
    * Qué es grid (o por qué otro sistema?)
    * Componentes (solo hay de bajo nivel)

## Contenido (II)
- lattice
    * Trellis plots
    * ...
    * Ejemplos
- ggplot2
    * Una gramática de gráficas
    * Capas, geometrías y componentes estéticos
    * Ejemplos

## Contenido (III)
- Maś allá: gráficas interactivas
    * ggvis y shiny
    * Integración con JS y htmlwidgets
    * Ayuda y otros recursos

## Qué es R?

> *"R is a language and environment for statistical computing and graphics."*

Entre otras cosas R incluye:

  - capacidad para almacenar y manipular datos **efectivamente**
  - un conjunto de operadores para hacer cálculos sobre arreglos, particularmente matrices
  - una colección grande, **coherente** e integrada de herramientas para el análisis de datos
  - **dispositivos gráficos para el análisis y visualización de datos, tanto en pantalla como en impreso**
  - un lenguaje de programación bien desarrollado, **simple y eficaz**

## [El ambiente para graficas de R](https://cran.r-project.org/web/views/Graphics.html) {.smaller}

```{r graphics-diagram, child = "graficas_files/graphics-diagram.rmd"}
```

Gráfica basada en [codigo](https://www.stat.auckland.ac.nz/~paul/RGraphics/organisation-graphicslevels.R) del libro [*R Graphics* de Paul Murrel](https://www.stat.auckland.ac.nz/~paul/RGraphics/rgraphics.html)

## Básicamente

```r
library("graphics")
library("grid")

# http://lattice.r-forge.r-project.org/
library("lattice")

# https://github.com/hadley/ggplot2
library("ggplot2")
```

# Gráficas Base

## Métodos (o todo de una):

- `plot()` para "diagramas de dispersión"
- `barplot()` para gráficas de barra
- `hist()` para histogramas
- `boxplot()` (y `bxp()`)  para diagramas de cajas y bigotes
- `pie()` - mejor evitarlos

## `plot()`

```{r plot-0, eval = FALSE}
set.seed(13579)

y <- rnorm(30)
types <- c("p", "l", "b", "c", "o", "h", "s", "S", "n")

par(mfrow = c(3, 3), cex = 0.6, mar = c(3, 3, 3, 1))

for (type in types){
  plot(y, type = type, main = paste0("type = ", type))
}
```

## `plot()`

```{r plot-0, echo = FALSE}
```

## `plot()`

`plot()` es una función genérica. Hay muchas formas de especificar los datos y dependiendo de lo que se le pase se genera uno u otro tipo de gráfico.

Veamos unos ejemplos usando el conjunto de datos `ìris`:

```{r iris-str}
str(iris)
```

## `plot()`

```{r plot-1}
plot(iris)
```

## `plot()`

```{r plot-2}
par(mfrow = c(1, 2), mar = c(5, 4, 2, 2))

plot(iris$Petal.Length, iris$Petal.Width)
plot(Petal.Length ~ Species, data = iris)
```

## `plot()` - Métodos

```{r plot-methods, eval = FALSE}
methods("plot")
```

```{r plot-methos-output, echo = FALSE}
plot_methods
```

## `barplot()` ... 

... pero antes unos datos más interesantes

```{r saber, eval = FALSE}
library("saber")  # Ver github.com/nebulae-co/saber
```

```{r saber-data, cache = TRUE}
data(SB11_20142)
glimpse(SB11_20142)

estratos <- with(SB11_20142, table(PERS_GENERO, FINS_ESTRATOVIVIENDAENERGIA))
educacion_madre <- SB11_20142 %$% table(PERS_GENERO, FINS_NIVELEDUCATIVOMADRE)
```

## `barplot()`

```{r barplot, eval = FALSE}
par(mfrow = c(2, 1), mar = c(4, 4, 1, 1), cex = 0.75)

barplot(estratos, angle = c(45, 135), density = 20, col = "grey",
        names = colnames(estratos), xlab = "Estrato")

legend("topright", title = "Genero", rownames(estratos), cex = 1.5,
       angle = c(45, 135), density = 20, fill = "gray")

barplot(educacion_madre, angle = c(45, 135), density = 20, 
        col = colors()[c(50, 100)], horiz = TRUE,
        names = colnames(educacion_madre), ylab = "Nivel Educativo\n Madre")
```

## `barplot()`

```{r barplot, echo = FALSE}
```

## `boxplot()` (o `bxp()`)

```{r boxplot, eval = FALSE}
par(mfrow = c(1, 2), mar = c(4, 4, 4, 2), cex = 0.8)

boxplot(MATEMATICAS_PUNT ~ FINS_ESTRATOVIVIENDAENERGIA, data = SB11_20142,
        col = "light grey")

boxplot(MATEMATICAS_PUNT ~ FINS_ESTRATOVIVIENDAENERGIA, data = SB11_20142,
        pch = 1:6, boxwex = 0.5, boxfill = "lightblue", frame.plot = FALSE,
        main = "Distribución del puntaje\n de matematicas por estrato",
        xlab = "Estrato", ylab = "Puntaje de matematicas")
```

## `boxplot()` (o `bxp()`)

```{r boxplot, echo = FALSE}
```

## Gráficas para 3 ó más dimensiones

- `persp()` superficies.
- `contour()` y `filled.contour()` contornos.
- `image()` cuadrícula con colores en $z$.
- `symbols()` diagramas de dispersión con símbolos de tamaño variable.
- `fourfoldplot()` para tablas de contingencia $2\times 2\times k$.
- `mosaicplot()`
- `stars()` para una visualización de varias variables cuantitativas.

```{r misc, eval = FALSE, echo = FALSE}
# persp-plot
y <- x <- seq(-10, 10, length= 30)
z <- outer(x, y, function(x, y){r <- sqrt(x^2+y^2); 10 * sin(r)/r})
z[is.na(z)] <- 1

persp(x, y, z, theta = 30, phi = 30, expand = 0.5, col = "lightblue")

# contour-image-plot
image(x, y, volcano, col = terrain.colors(100), axes = FALSE)
contour(x, y, volcano, levels = seq(90, 200, by = 5),
        add = TRUE, col = "peru")
axis(1, at = seq(100, 800, by = 100))
axis(2, at = seq(100, 600, by = 100))
box()
title(main = "Maunga Whau Volcano", font.main = 4)

# mosaic-plot
mosaicplot(~ FINS_ESTRATOVIVIENDAENERGIA + FINS_NIVELEDUCATIVOMADRE, 
           data = SB11_20142)
```

## Otras funciones gráficas de alto nivel:

- `matplot()` para gráficas de dispersión cruzando matrices.
- `stripchart()` gráfica de dispersión en una sola dimensión.
- `curve()` para gráficar funciones (como `plot.function()`).

## Algunas más modernas o específicas:
Además de los métodos específicos para `plot()`:

- `dotchart()` para resumir una variable cuantitativa cruzada con una o más variables categóricas.
- `coplot()` gráficas condicionales (Trellis).
- `sunflowerplot()` para diagramas de dispersión con datos superpuestos - alternativas para esto son `image()` o `hexbin::hexbin()`. 
- `assocplot()` visualización de una prueba de independencia para una tabla de contingencia bi-dimensional - `vcd` extiende esto y ofrece más herramientas para datos categóricos.

## `par()` y algunos parametros gráficos 

# Grid

## Qué es grid?

## Componentes de bajo nivel

## Lattice

For example ~x|A means display numeric variable x for each level of factor A. y~x | A*B means display the relationship between numeric variables y and x separately for every combination of factor A and B levels.

Gráfica       | Descripción                        | Ejemplo de fórmula | 
--------------|------------------------------------|--------------------|
histogram()   | Histogram                          | ~x                 |  
densityplot() | Kernel Density Plot                | ~x|A*B             |
qqmath()      | Theoretical Quantile Plot          |                    |
qq()          | Two-sample Quantile Plot           |                    |  
stripplot()   | Stripchart                         | A~x or x~A         |
bwplot()      | Comparative Box-and-Whisker Plots  | x~A or A~x         |
dotplot()     | Cleveland Dot Plot                 | ~x|A               |
barchart()    | Bar Plot                           | x~A or A~x         |
xyplot()      | Scatter Plot                       | y~x|A              |
splom()       | Scatter-Plot Matrix                | data frame         |
contourplot() | Contour Plot of Surfaces           | z~x*y              |
levelplot()   | False Color Level Plot of Surfaces | z~y*x              |
wireframe()   | 3D Perspective Plot of Surfaces    | z~y*x              |
cloud()       | 3D Scatter Plot                    | z~x*y|A            |
parallel()    | Parallel Coordinates Plot          | data frame         |

# ggplot

## R moderno o el ["Hadleyverse"](https://barryrowlingson.github.io/hadleyverse/) {.build}

- `readr`, `readxl` y `haven` lectura de archivos.
- `lubridate` manejo de fechas y tiempo.
- `stringr` interface a `stringi` para manejo de caracteres.
- `dplyr` y `tidyr` manipulación y limpieza de datos.
- `ggplot2` *una gramática de gráficas - util para abstraer y construir visualizaciones*.

## ggplot2

 - Gráficos por capas
 - Gestión de la gráfica como objeto
 - Graficar, guardar, abrir y editar.

```{r qplot, echo = FALSE, fig.height = 3.5}
qplot(mpg, wt, data=mtcars, colour=factor(cyl), size=carb)
```

## ggplot2 (geoms)

```{r geoms-intro}
ggplot(mtcars) + aes(y = mpg, x = factor(cyl)) + geom_violin()
```

## [ggplot2 (geoms)](geoms.html) {.smaller}

```{r geoms-table, echo = FALSE}
ls(pattern = '^geom_', env = as.environment('package:ggplot2')) %>%
  setdiff("geom_violin") %>% matrix(9) %>% kable
```

## ggplot2 (stats)

```{r stats-intro}
ggplot(mtcars) + aes(y = mpg, x = factor(cyl)) + geom_violin()
```

# Más allá: Gráficas interactivas

Una deuda grande de R.

# ggvis y shiny

# Integración con JS - htmlwidgets

## Una tabla

Función    | Vectores      | Matrices                    | Arreglos         | 
-----------|---------------|-----------------------------|------------------|
Dimensión  | `length()`    | `ncol()` y `nrow()`         | `dim()`          |  
Nombres    | `names()`     | `rownames()` y `colnames()` | `dimnames()`     |
Concatenar | `c()`         | `cbind()` y `rbind()`       | `abind::abind()` |  

## Ayuda y otros recursos {.build}

La vista de tareas con la que empezamos: [_Vista de Tareas_/Gráficas](http://cran.r-project.org/web/views/grafics).

Canales: [en twitter #rstats](https://twitter.com/hashtag/rstats) y en [StackOverflow el tag R](http://stackoverflow.com/questions/tagged/r). También pueden [googlea-R](https://www.google.com.co/#q=R) R + "pregunta".  

Algunas buenas referencias:

- [Quick R - Gráficas](http://www.statmethods.net/graphs/index.html)
- [Springer - Use R Series](http://www.springer.com/series/6991?detailsPage=titles) R en la práctica en diferentes contextos.
- ...

## Preguntas?

```{r}
png_meme_generator <- function(web.path, over.text, under.text)
{
  con <- url(web.path, open = 'rb')
  rawpng <- readBin(con, what = 'raw', n = 50000)
  close(con)
  
  img <- png::readPNG(rawpng)
  
  par(xpd = NA, mgp = c(0, 0, 0), oma = c(0, 0, 0, 0), ann = F)
  
  plot.new()
  plot.window(0:1, 0:1)
  
  usr<-par("usr")    
  rasterImage(img, usr[1], usr[3], usr[2], usr[4])
  
  text(.5, 1.05,  over.text, cex = 2, col = "#000000", pos = 3)
  text(.5, -.05, under.text, cex = 2, col = "#000000", pos = 1)
}
```

## Preguntas?

```{r meme, fig.width = 5, fig.align = "center"}
png_meme_generator(
  "http://i2.kym-cdn.com/photos/images/original/000/208/140/1322357772581.png",
  "Tu cara cuando ves", 
  "un meme hecho en R")
```

## Colofón {.smaller .left-margin}

Esta presentación fue escrita en RMarkdown desde RStudio y compilada por `rmarkdown` en la plantilla `ioslides` de Google gracias a `knitr` y `pandoc`. Publicada en la web en GitHub gracias a GitHub Pages.
